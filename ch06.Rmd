---
title: "Chapter 6"
output: html_notebook
---

# 6 Nonlinear least squares

## 6.1 nls() from package stats

### 6.1.1 A simple example

```{r}
## ----label=C06nlschunk101, echo=TRUE, cache=TRUE, fig.height=5-----------
Weight <- c(
  184.35, 182.51, 180.45, 179.91, 177.91, 175.81, 173.11,
  170.06, 169.31, 165.1, 163.11, 158.3, 155.8, 154.31,
  153.86, 154.2, 152.2, 152.8, 150.3, 147.8, 146.1, 145.6,
  142.5, 142.3, 139.4, 137.9, 133.7, 133.7, 133.3, 131.2,
  133, 132.2, 130.8, 131.3, 129, 127.9, 126.9, 127.7,
  129.5, 128.4, 125.4, 124.9, 124.9, 118.2, 118.2, 115.3,
  115.7, 116, 115.5, 112.6, 114, 112.6
)
Days <- c(
  0, 4, 7, 7, 11, 18, 24, 30, 32, 43, 46, 60, 64, 70, 71,
  71, 73, 74, 84, 88, 95, 102, 106, 109, 115, 122, 133, 137,
  140, 143, 147, 148, 149, 150, 153, 156, 161, 164, 165,
  165, 170, 176, 179, 198, 214, 218, 221, 225, 233, 238,
  241, 246
)
wl <- data.frame(Weight = Weight, Days = Days)
wlmod <- "Weight ~ b0 + b1*2^(-Days/th)"
wlnls <- nls(wlmod, data = wl, start = c(b0 = 1, b1 = 1, th = 1))
summary(wlnls)
plot(wl$Days, wl$Weight)
title("Weight loss over time in Days")
points(wl$Days, predict(wlnls), type = "l", col = "red")
```

## 6.2 A more difficult case

```{r}
## ----label=C06nlschunk01, echo=TRUE--------------------------------------
options(width = 60)
pastured <- data.frame(
  time = c(9, 14, 21, 28, 42, 57, 63, 70, 79),
  yield = c(
    8.93, 10.8, 18.59, 22.33, 39.35,
    56.11, 61.73, 64.62, 67.08
  )
)
plot(yield ~ time, data = pastured)
```

```{r}
regmod <- "yield ~ t1 - t2*exp(-exp(t3+t4*log(time)))"
```

```{r}
ones <- c(t3 = 1, t4 = 1, t1 = 1, t2 = 1) # all ones start
anls <- try(nls(regmod, start = ones, trace = FALSE, data = pastured))
anls
```

```{r}
huetstart <- c(t3 = 0, t4 = 1, t1 = 70, t2 = 60)
anlsx <- try(nls(regmod, start = huetstart, trace = FALSE, data = pastured))
anlsx
```

```{r}
library(nlmrt)
anmrt <- nlxb(regmod, start = ones, trace = FALSE, data = pastured)
anmrt
```

```{r}
anmrtx <- try(nlxb(regmod, start = huetstart, trace = FALSE, data = pastured))
anmrtx
```

```{r}
fhard <- function(time, t1, t2, t3, t4) {
  time <- as.vector(time)
  t1 - t2 * exp(-exp(t3 + t4 * log(time)))
}
params <- append(
  list(time = seq(9, 80, length.out = 1001)),
  as.list(anmrtx$coefficients)
)
y <- do.call(fhard, params)
```

```{r}
plot(yield ~ time, data = pastured)
lines(params$time, y, col = "red")
```

```{r}
pastjac <- model2jacfun(regmod, ones, funname = "pastjac")
J1 <- pastjac(ones, yield = pastured$yield, time = pastured$time)
svd(J1)$d
## [1] 3.0000e+00 1.3212e-09 2.1637e-16 3.9400e-26
J2 <- pastjac(huetstart, yield = pastured$yield, time = pastured$time)
svd(J2)$d
## [1] 3.0005e+00 1.5143e-01 1.1971e-04 1.8584e-10
```

```{r}
Jnmrtx <- pastjac(coef(anmrtx), yield = pastured$yield, time = pastured$time)
svals <- svd(Jnmrtx)$d
barplot(svals,
  main = "Singular values at nlxb solution to pasture problem",
  horiz = TRUE
)
```

```{r}
require(minpack.lm)
## Loading required package: minpack.lm
aminp <- try(nlsLM(regmod, start = ones, trace = FALSE, data = pastured))
summary(aminp)
```

```{r}
aminpx <- try(nlsLM(regmod, start = huetstart, trace = FALSE, data = pastured))
print(aminpx)
```

```{r}
## ----label=C06nlschunk05b, echo=TRUE-------------------------------------
require(nls2)
set.seed(123) # for reproducibility
regmodf <- as.formula(regmod) # just in case
m100 <- c(t1 = -100, t2 = -100, t3 = -100, t4 = -100)
p100 <- (-1) * m100
gstart <- data.frame(rbind(m100, p100))
anls2 <- try(nls2(regmodf,
  start = gstart, data = pastured,
  algorithm = "random-search", control = list(maxiter = 1000)
))
print(anls2)
```

```{r}
## ----label=C06nlschunk05c, echo=TRUE-------------------------------------
options(show.error.messages = FALSE)
require(nls2)
set.seed(123) # for reproducibility
plinform <- yield ~ cbind(1, -exp(-exp(t3 + t4 * log(time))))
gstartpl <- data.frame(rbind(c(-10, 1), c(10, 8)))
names(gstartpl) <- c("t3", "t4")
anls2plb <- try(nls2(plinform,
  start = gstartpl, data = pastured,
  algorithm = "plinear-brute", control = list(maxiter = 200)
))
options(show.error.messages = TRUE)
print(anls2plb)
```

```{r}
## ====================================
options(show.error.messages = FALSE)
anls2plr <- try(nls2(plinform,
  start = gstartpl, data = pastured,
  algorithm = "plinear-random", control = list(maxiter = 200)
), silent = TRUE)
print(anls2plr)
options(show.error.messages = TRUE)
```

```{r}
source("./resources/C06pastured1.R", echo = FALSE)
source("./resources/C06pasturednlxb.R", echo = FALSE)
source("./resources/C06pasturedSVD.R", echo = FALSE)
# X11() # ensure new graphics screen
source("./resources/C06pasturednlsLM.R", echo = FALSE)
source("./resources/C06pasturednls2.R", echo = FALSE)


## ----label=C06nlschunk05d, echo=TRUE, fig.height=4.75--------------------
require(nlmrt)
splb <- coef(anls2plb)
splr <- coef(anls2plr)
names(splb) <- names(huetstart)
names(splr) <- names(huetstart)
anlsfromplb <- nls(regmod, start = splb, trace = FALSE, data = pastured)
anlsfromplr <- nls(regmod, start = splr, trace = FALSE, data = pastured)
agomp <- wrapnls(regmodf, start = huetstart, data = pastured)
fitnlxb <- fitted(agomp)
fitnls2b <- fitted(anls2plb)
fitnls2r <- fitted(anls2plr)
plot(pastured$time, fitnlxb, type = "l", lwd = 2, xlab = "time")
points(pastured$time, fitnls2b, col = "red", type = "l", lty = "dashed", lwd = 2)
points(pastured$time, fitnls2r, col = "blue", type = "l", lty = "dotdash", lwd = 2)
points(pastured$time, pastured$yield)
title(main = "Fitted models for pasture data")
sstr <- "best = solid line, nls2.plinear.brute = dashed, nls2.plinear.random = dotdash"
title(sub = sstr, cex.sub = 0.8)
resnlxb <- pastured$yield - fitnlxb
resnls2b <- pastured$yield - fitnls2b
resnls2r <- pastured$yield - fitnls2r


## ----label=C06nlschunk05e, echo=FALSE, cache=TRUE, fig.height=4.75-------
# X11() # added to website file to avoid overwrite of screen plot
boxplot(data.frame(resnlxb, resnls2b, resnls2r))
title(main = "Model residuals")
title(sub = "best, nls2.plinear.brute, nls2.plinear.random")
```

```{r}
ssfn <- model2ssfun(regmodf, ones)
grfn <- model2grfun(regmodf, ones)
time <- pastured$time
yield <- pastured$yield
# aopto<-optim(ones, ssfn, gr=grfn, yield=yield, time=time,
# method=’BFGS’, control=list(maxit=10000)) print(aopto) ##
# We did not run this one.
```

```{r}
aopto <- optim(ones, ssfn, gr = grfn, yield = yield, time = time, method = "BFGS", control = list(maxit = 10000))
print(aopto)
```

```{r}
aopth <- optim(huetstart, ssfn,
  gr = grfn, yield = yield, time = time,
  method = "BFGS", control = list(maxit = 10000)
)
print(aopth)
```

# 6.3 The structure of the nls() solution

```{r}
require(nlmrt)
wlmod <- "Weight ~ b0 + b1*2^(-Days/th)"
wlnlxb <- nlxb(wlmod, data = wl, start = c(b0 = 1, b1 = 1, th = 1))
wlnlxb
```

```{r}
coef(wlnls)
```

```{r}
coef(wlnlxb)
```

## 6.4 Concerns with nls()

### 6.4.1 Small residuals

```{r}
## ----label=C06zeroresprob1, echo=TRUE, cache=TRUE------------------------
require(nlmrt)
x <- 1:10
y <- 2 * x + 3 # perfect fit
yeps <- y + rnorm(length(y), sd = 0.01) # added noise
anoise <- nls(yeps ~ a + b * x, start = list(a = 0.12345, b = 0.54321))
summary(anoise)
```

```{r}
aperf <- try(nls(y ~ a + b * x, start = list(a = 0.12345, b = 0.54321)))
print(strwrap(aperf))
```


```{r}
ldata <- data.frame(x = x, y = y)
aperfn <- try(nlxb(y ~ a + b * x, start = list(a = 0.12345, b = 0.54321), data = ldata))
aperfn
```

### 6.4.2 Robustness – “singular gradient” woes

```{r}
x <- c(60, 80, 100, 120)
y <- c(0.8, 6.5, 20.5, 45.9)
mydata <- data.frame(x, y)
pnames <- c("a", "b", "d")
npar <- length(pnames)
st <- c(1, 1, 1)
names(st) <- pnames
plot(x, y)
```

```{r}
rnls <- try(nls(y ~ exp(a + b * x) + d, start = st, data = mydata), silent = TRUE)
if (class(rnls) == "try-error") {
  cat("nls() failed (singular gradient?)\n")
} else {
  summary(rnls)
}
```

```{r}
require(nlmrt)
rnlx0 <- try(nlxb(y ~ exp(a + b * x) + d, start = st, data = mydata), silent = TRUE)
cat("Found sum of squares ", rnlx0$ssquares, "\n")
print(rnlx0$coefficients)
```

```{r}
rnlx0 <- try(nlxb(y ~ exp(a + b * x) + d, start = list(a = 0.5, b = 0.1, d = -5e47), data = mydata), silent = TRUE)
rnlx0
```

```{r}
rnlx1 <- try(nlxb(y ~ exp(a + b * x) + d,
  start = st, data = mydata,
  control = list(rofftest = FALSE)
), silent = TRUE)
# cat("Found sum of squares ",rnlx1$ssquares,"\n")
rnlx1
```

```{r}
rnlx2 <- try(nlxb(y ~ exp(a + b * x) + d,
  start = st, data = mydata,
  control = list(rofftest = FALSE, smallsstest = FALSE)
), silent = TRUE)
# cat("Found sum of squares ",rnlx2$ssquares,"\n")
rnlx2
```

### Bounds with nls()

```{r}
## ----label=C06boundnls1, echo=TRUE, cache=TRUE---------------------------
ydat <- c(
  5.308, 7.24, 9.638, 12.866, 17.069, 23.192, 31.443,
  38.558, 50.156, 62.948, 75.995, 91.972
) # for testing
tdat <- 1:length(ydat) # for testing
weeddata <- data.frame(y = ydat, t = tdat)
plot(tdat, ydat)
```

```{r}
require(nlmrt)
hobmod <- "y~100*b1/(1+10*b2*exp(-0.1*b3*t))"
st <- c(b1 = 1, b2 = 1, b3 = 1)
low <- c(-Inf, -Inf, -Inf)
up <- c(2, 2, 2)

cat("try nlxb\n")
anlxb2 <- nlxb(hobmod, st, data = weeddata, lower = low, upper = up)
anlxb2
```

```{r}
try(anls2p <- nls(hobmod, st, data = weeddata, lower = low, upper = up, algorithm = "port"))
summary(anls2p)
anls2p$m$deviance()
```

```{r}
require(minpack.lm)
aLM2 <- nlsLM(hobmod, st, data = weeddata, lower = low, upper = up)
summary(aLM2)
aLM2$m$deviance()
```

## 6.5 Some ancillary tools for nonlinear least squares 

### 6.5.1 Starting values and self-starting problems

```{r}
## ----label=C06hobbselfstart2, echo=TRUE----------------------------------
## Put in weeddata here as precaution. Maybe reset workspace.
anlss2 <- nls(y ~ SSlogis(t, p1, p2, p3), data = weeddata)
summary(anlss2)
anlss2$m$deviance()
```

### 6.5.2 Converting model expressions to sum-of-squares functions












